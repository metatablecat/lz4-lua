local ServerScriptService = game:GetService("ServerScriptService")
local lz4 = require(ServerScriptService.lz4)

local function hex(str)
	local out = ""
	for i = 1, string.len(str) do
		local c = string.sub(str, i, i)
		local b = string.byte(c)
		local padding = "" if b < 0x10 then padding = "0" end

		out = out .. padding .. string.format("%x ", b)
	end

	return out
end

local Tests = {
	["decompression works"] = function()
		local lz4_compressed_data = "\x7d\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\xd0\x01\x00\x00\x00\x04\x00\x00\x00\x4e\x61\x6d\x65\x01\x09\x00\xe0\x72\x62\x78\x6d\x06\x00\x00\x00\x53\x74\x72\x69\x6e\x67\x1b\x00\xf0\x09\x42\x6f\x6f\x6c\x05\x00\x00\x00\x49\x6e\x74\x33\x32\x07\x00\x00\x00\x46\x6c\x6f\x61\x74\x33\x32\x14\x00\x60\x43\x68\x75\x6e\x6b\x0d\x25\x00\xf0\x0b\x69\x6e\x61\x72\x79\x54\x79\x70\x65\x4d\x61\x70\x0a\x00\x00\x00\x41\x74\x74\x72\x69\x62\x75\x74\x65\x73\x3c\x00\x00\x19\x00\x20\x73\x10\x4d\x00\xf0\x00\x79\x74\x65\x49\x6e\x74\x65\x72\x6c\x65\x61\x76\x69\x6e\x67"
		local expected_data = "\x01\x00\x00\x00\x04\x00\x00\x00\x4e\x61\x6d\x65\x01\x04\x00\x00\x00\x72\x62\x78\x6d\x06\x00\x00\x00\x53\x74\x72\x69\x6e\x67\x04\x00\x00\x00\x42\x6f\x6f\x6c\x05\x00\x00\x00\x49\x6e\x74\x33\x32\x07\x00\x00\x00\x46\x6c\x6f\x61\x74\x33\x32\x05\x00\x00\x00\x43\x68\x75\x6e\x6b\x0d\x00\x00\x00\x42\x69\x6e\x61\x72\x79\x54\x79\x70\x65\x4d\x61\x70\x0a\x00\x00\x00\x41\x74\x74\x72\x69\x62\x75\x74\x65\x73\x05\x00\x00\x00\x54\x79\x70\x65\x73\x10\x00\x00\x00\x42\x79\x74\x65\x49\x6e\x74\x65\x72\x6c\x65\x61\x76\x69\x6e\x67"

		return lz4.decompress(lz4_compressed_data) == expected_data
	end,
	
	["compressed data can be decompressed"] = function()
		local data_chunk = "The LZ4 algorithms aims to provide a good trade-off between speed and compression ratio. Typically, it has a smaller (i.e., worse) compression ratio than the similar LZO algorithm, which in turn is worse than algorithms like DEFLATE. However, LZ4 compression speed is similar to LZO and several times faster than DEFLATE, while decompression speed is significantly faster than LZO"
		local c = lz4.compress(data_chunk)
		return lz4.decompress(c) == data_chunk
	end,

	["arbitrarily large data"] = function()
		-- this test fails, please help fix this

		local data = ""
		for i = 1, 512 do
			local char = string.char(math.random(65,90))
			data ..= string.rep(char, 8)
		end

		local c = lz4.compress(data)
		local d = lz4.decompress(c)

		return d == data
	end,

	["can decompress arbitrary C++ streams"] = function()
		local stream = "\x9b\x01\x00\x00\x40\x03\x00\x00\x00\x00\x00\x00\xf4\x1f\x02\x00\x00\x00\x06\x00\x00\x00\x53\x6f\x75\x72\x63\x65\x01\x2d\x03\x00\x00\x6c\x6f\x63\x61\x6c\x20\x50\x6c\x75\x67\x69\x6e\x20\x3d\x20\x73\x63\x72\x69\x70\x74\x2e\x50\x61\x72\x65\x6e\x07\x00\x22\x0d\x0a\x25\x00\xf3\x09\x53\x74\x75\x64\x69\x6f\x53\x65\x72\x76\x69\x63\x65\x20\x3d\x20\x67\x61\x6d\x65\x3a\x47\x65\x74\x12\x00\x29\x28\x22\x21\x00\x45\x22\x29\x0d\x0a\x3a\x00\x01\x70\x00\x93\x53\x74\x72\x69\x6e\x67\x73\x20\x3d\x6f\x00\x81\x2e\x53\x72\x63\x2e\x52\x65\x73\x1d\x00\x22\x73\x2e\x95\x00\x03\x25\x00\x04\x3a\x00\x10\x4c\x9f\x00\x43\x69\x7a\x65\x64\x18\x00\x0f\x3d\x00\x05\x0c\x28\x00\x04\x40\x00\xdc\x74\x72\x61\x6e\x73\x6c\x61\x74\x6f\x72\x20\x3d\x20\x25\x00\x00\xbd\x00\x15\x54\x21\x00\x19\x28\xbf\x00\x12\x2e\x0e\x00\x01\x33\x00\x44\x65\x49\x64\x29\x51\x00\x86\x66\x61\x6c\x6c\x62\x61\x63\x6b\x38\x00\x2a\x20\x3d\xe0\x00\x0b\x56\x00\x62\x22\x65\x6e\x2d\x75\x73\x0e\x01\xf1\x09\x72\x65\x74\x75\x72\x6e\x20\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x6b\x65\x79\x2c\x20\x2e\x2e\x2e\x2b\x01\x42\x20\x20\x20\x20\x69\x01\x85\x73\x75\x63\x63\x65\x73\x73\x2c\xbe\x00\x38\x69\x6f\x6e\x20\x00\x21\x61\x72\x09\x01\x50\x7b\x2e\x2e\x2e\x7d\x65\x01\x00\x3a\x00\x04\x34\x00\x07\x33\x00\x95\x20\x3d\x20\x70\x63\x61\x6c\x6c\x28\x70\x00\x12\x29\x2c\x00\x00\x02\x00\x03\x8b\x00\x04\x2f\x00\xe2\x6f\x72\x3a\x46\x6f\x72\x6d\x61\x74\x42\x79\x4b\x65\x79\x99\x00\x00\x67\x00\x03\x32\x00\x20\x65\x6e\x02\x01\x02\x3e\x00\x24\x69\x66\x6d\x00\x43\x20\x74\x68\x65\x99\x00\x00\x02\x00\x0b\x53\x00\x05\xb5\x00\x34\x65\x6e\x64\x3c\x00\x03\x39\x00\x14\x2c\x77\x00\x0f\xa6\x00\x14\x0e\x75\x01\x0f\xae\x00\x52\x03\xd1\x00\xa0\x6b\x65\x79\x0d\x0a\x65\x6e\x64\x0d\x0a"
		local expected_output = "\x02\x00\x00\x00\x06\x00\x00\x00\x53\x6f\x75\x72\x63\x65\x01\x2d\x03\x00\x00\x6c\x6f\x63\x61\x6c\x20\x50\x6c\x75\x67\x69\x6e\x20\x3d\x20\x73\x63\x72\x69\x70\x74\x2e\x50\x61\x72\x65\x6e\x74\x2e\x50\x61\x72\x65\x6e\x74\x0d\x0a\x6c\x6f\x63\x61\x6c\x20\x53\x74\x75\x64\x69\x6f\x53\x65\x72\x76\x69\x63\x65\x20\x3d\x20\x67\x61\x6d\x65\x3a\x47\x65\x74\x53\x65\x72\x76\x69\x63\x65\x28\x22\x53\x74\x75\x64\x69\x6f\x53\x65\x72\x76\x69\x63\x65\x22\x29\x0d\x0a\x0d\x0a\x6c\x6f\x63\x61\x6c\x20\x53\x6f\x75\x72\x63\x65\x53\x74\x72\x69\x6e\x67\x73\x20\x3d\x20\x50\x6c\x75\x67\x69\x6e\x2e\x53\x72\x63\x2e\x52\x65\x73\x6f\x75\x72\x63\x65\x73\x2e\x53\x6f\x75\x72\x63\x65\x53\x74\x72\x69\x6e\x67\x73\x0d\x0a\x6c\x6f\x63\x61\x6c\x20\x4c\x6f\x63\x61\x6c\x69\x7a\x65\x64\x53\x74\x72\x69\x6e\x67\x73\x20\x3d\x20\x50\x6c\x75\x67\x69\x6e\x2e\x53\x72\x63\x2e\x52\x65\x73\x6f\x75\x72\x63\x65\x73\x2e\x4c\x6f\x63\x61\x6c\x69\x7a\x65\x64\x53\x74\x72\x69\x6e\x67\x73\x0d\x0a\x6c\x6f\x63\x61\x6c\x20\x74\x72\x61\x6e\x73\x6c\x61\x74\x6f\x72\x20\x3d\x20\x4c\x6f\x63\x61\x6c\x69\x7a\x65\x64\x53\x74\x72\x69\x6e\x67\x73\x3a\x47\x65\x74\x54\x72\x61\x6e\x73\x6c\x61\x74\x6f\x72\x28\x53\x74\x75\x64\x69\x6f\x53\x65\x72\x76\x69\x63\x65\x2e\x53\x74\x75\x64\x69\x6f\x4c\x6f\x63\x61\x6c\x65\x49\x64\x29\x0d\x0a\x6c\x6f\x63\x61\x6c\x20\x66\x61\x6c\x6c\x62\x61\x63\x6b\x54\x72\x61\x6e\x73\x6c\x61\x74\x6f\x72\x20\x3d\x20\x53\x6f\x75\x72\x63\x65\x53\x74\x72\x69\x6e\x67\x73\x3a\x47\x65\x74\x54\x72\x61\x6e\x73\x6c\x61\x74\x6f\x72\x28\x22\x65\x6e\x2d\x75\x73\x22\x29\x0d\x0a\x0d\x0a\x72\x65\x74\x75\x72\x6e\x20\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x6b\x65\x79\x2c\x20\x2e\x2e\x2e\x29\x0d\x0a\x0d\x0a\x20\x20\x20\x20\x6c\x6f\x63\x61\x6c\x20\x73\x75\x63\x63\x65\x73\x73\x2c\x20\x74\x72\x61\x6e\x73\x6c\x61\x74\x69\x6f\x6e\x0d\x0a\x20\x20\x20\x20\x6c\x6f\x63\x61\x6c\x20\x61\x72\x67\x73\x20\x3d\x20\x7b\x2e\x2e\x2e\x7d\x0d\x0a\x0d\x0a\x20\x20\x20\x20\x73\x75\x63\x63\x65\x73\x73\x2c\x74\x72\x61\x6e\x73\x6c\x61\x74\x69\x6f\x6e\x20\x3d\x20\x70\x63\x61\x6c\x6c\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x29\x0d\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x20\x74\x72\x61\x6e\x73\x6c\x61\x74\x6f\x72\x3a\x46\x6f\x72\x6d\x61\x74\x42\x79\x4b\x65\x79\x28\x6b\x65\x79\x2c\x20\x61\x72\x67\x73\x29\x0d\x0a\x20\x20\x20\x20\x65\x6e\x64\x29\x0d\x0a\x0d\x0a\x20\x20\x20\x20\x69\x66\x20\x73\x75\x63\x63\x65\x73\x73\x20\x74\x68\x65\x6e\x0d\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x20\x74\x72\x61\x6e\x73\x6c\x61\x74\x69\x6f\x6e\x0d\x0a\x20\x20\x20\x20\x65\x6e\x64\x0d\x0a\x0d\x0a\x20\x20\x20\x20\x73\x75\x63\x63\x65\x73\x73\x2c\x74\x72\x61\x6e\x73\x6c\x61\x74\x69\x6f\x6e\x20\x3d\x20\x70\x63\x61\x6c\x6c\x28\x66\x75\x6e\x63\x74\x69\x6f\x6e\x28\x29\x0d\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x20\x66\x61\x6c\x6c\x62\x61\x63\x6b\x54\x72\x61\x6e\x73\x6c\x61\x74\x6f\x72\x3a\x46\x6f\x72\x6d\x61\x74\x42\x79\x4b\x65\x79\x28\x6b\x65\x79\x2c\x20\x61\x72\x67\x73\x29\x0d\x0a\x20\x20\x20\x20\x65\x6e\x64\x29\x0d\x0a\x0d\x0a\x20\x20\x20\x20\x69\x66\x20\x73\x75\x63\x63\x65\x73\x73\x20\x74\x68\x65\x6e\x0d\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x20\x74\x72\x61\x6e\x73\x6c\x61\x74\x69\x6f\x6e\x0d\x0a\x20\x20\x20\x20\x65\x6e\x64\x0d\x0a\x0d\x0a\x20\x20\x20\x20\x72\x65\x74\x75\x72\x6e\x20\x6b\x65\x79\x0d\x0a\x65\x6e\x64\x0d\x0a" --please i manually hand decoded this

		return lz4.decompress(stream) == expected_output
	end
}

for test, call in Tests do
	local worked, testDidWork = pcall(call)
	if not worked then
		print(test, "ERRORED", testDidWork)
	else
		print(test, testDidWork)
	end
end